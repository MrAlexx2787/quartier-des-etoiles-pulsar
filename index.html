<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte du Logis â€“ Quartier des Ã©toiles (Horde)</title>

  <style>
    .tooltip-label {
      color: #caa500;
      font-weight: bold;
    }

    body {
      margin: 0;
      background: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      color: white;
      font-family: Arial, sans-serif;
    }

    .map-container {
      position: relative;
      width: 100%;
      max-width: 1400px;
      border: 2px solid #444;
      margin-bottom: 12px;
      overflow: hidden;
      cursor: grab;
      background: #000;
    }

    .map-container:active {
      cursor: grabbing;
    }

    .map-inner {
      position: relative;
      transform-origin: 0 0;
      transition: transform 0.05s linear;
    }

    .map-container img {
      width: 100%;
      display: block;
    }

    .plot {
      position: absolute;
      width: 26px;
      height: 26px;
      background-image: url("Maison_GRISE.png");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border: none;
      color: white;
      font-size: 11px;
      font-weight: bold;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 2px;
      transform: translate(-50%, -50%);
      pointer-events: auto;
      text-shadow: 0 0 2px #000, 0 0 4px #000;
    }

    .taken {
      background-image: url("Maison_OR.png") !important;
    }

    .focus-highlight {
      box-shadow: 0 0 12px 4px rgba(255, 215, 0, 0.8);
      border-radius: 50%;
    }

    .marker {
      position: absolute;
      width: 26px;
      height: 26px;
      transform: translate(-50%, -50%);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: auto;
    }

    .marker-portal {
      background-image: url("Portail.png");
    }

    .marker-flight {
      background-image: url("Taxi.png");
    }

    .tooltip {
      position: absolute;
      background: #050505;
      border: 1px solid #ffd100;
      padding: 6px 8px;
      font-size: 12px;
      color: #ffffff;
      box-shadow: 0 0 8px rgba(0,0,0,0.8);
      z-index: 2000;
      pointer-events: none;
      max-width: 260px;
      display: none;
    }

    .tooltip-title {
      color: #ffd100;
      font-weight: bold;
    }

    .tooltip-body {
      margin-top: 3px;
    }

    .admin-btn {
      background: #333;
      color: #ffd100;
      border: 1px solid #555;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .admin-btn:hover {
      background: #444;
    }

    .admin-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #111;
      border: 2px solid #444;
      padding: 20px;
      z-index: 2500;
      color: white;
      display: none;
      box-shadow: 0 0 15px rgba(0,0,0,0.8);
    }

    .admin-popup input {
      padding: 6px;
      width: 250px;
      margin-bottom: 10px;
    }

    .panel {
      width: 100%;
      max-width: 1917px;
      border: 1px solid #444;
      background: #111;
      padding: 10px 12px;
      box-sizing: border-box;
      margin-top: 5px;
      margin-bottom: 15px;
      display: none;
    }

    .form-row {
      margin-bottom: 10px;
    }

    .form-row label {
      margin-right: 5px;
      display: inline-block;
      min-width: 120px;
    }

    .form-row input,
    .form-row select,
    .form-row button,
    .form-row textarea {
      padding: 4px;
    }

    .disconnect-btn {
      margin-top: 10px;
      background: #550000;
      color: #fff;
      padding: 6px 10px;
      border: 1px solid #aa0000;
      cursor: pointer;
      font-size: 13px;
      border-radius: 4px;
    }

    .disconnect-btn:hover {
      background: #770000;
    }

    .legend-box {
      position: absolute;
      top: 10%;
      right: 3%;
      background: #050505;
      border: 1px solid #ffd100;
      padding: 10px 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.8);
      z-index: 900;
      max-width: 260px;
      font-size: 13px;
    }

    .legend-header {
      font-weight: bold;
      color: #ffd100;
      margin-bottom: 6px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .legend-item input {
      margin: 0;
    }

    .legend-icon {
      width: 18px;
      height: 18px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    .legend-free {
      background-image: url("Maison_GRISE.png");
    }

    .legend-taken {
      background-image: url("Maison_OR.png");
    }

    .legend-flight {
      background-image: url("Taxi.png");
    }

    .legend-portal {
      background-image: url("Portail.png");
    }

    .legend-separator {
      border-top: 1px solid #ffd100;
      margin: 6px 0 4px 0;
    }

    .legend-available {
      margin-top: 2px;
      font-weight: bold;
      color: #ffd100;
      cursor: pointer;
    }

    .recensement-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 520px;
      max-height: 75%;
      background: #050505;
      border: 2px solid #caa500;
      box-shadow: 0 0 25px rgba(0,0,0,0.9);
      z-index: 3000;
      padding: 0;
      display: none;
      overflow: hidden;
    }

    .recensement-header {
      background: #111;
      border-bottom: 1px solid #caa500;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .recensement-title {
      color: #ffd100;
      font-size: 18px;
      font-weight: bold;
    }

    .recensement-close {
      background: #550000;
      border: 1px solid #aa0000;
      color: white;
      font-weight: bold;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .recensement-close:hover {
      background: #770000;
    }

    .recensement-content {
      padding: 12px;
      overflow-y: auto !important;
      max-height: 600px !important;
      color: #fff;
      background: #050505cc;
      scrollbar-width: thin;
      scrollbar-color: #caa500 #1a1a1a;
    }

    .recensement-content::-webkit-scrollbar {
      width: 10px;
    }

    .recensement-content::-webkit-scrollbar-track {
      background: #1a1a1a;
      border-left: 1px solid #2c2c2c;
    }

    .recensement-content::-webkit-scrollbar-thumb {
      background: #caa500;
      border-radius: 4px;
      border: 1px solid #000;
    }

    .recensement-content::-webkit-scrollbar-thumb:hover {
      background: #ffdb47;
    }

    .recensement-popup:hover {
      overscroll-behavior: contain;
    }

    .recensement-separator {
      border-top: 1px solid #caa500;
      margin: 10px 0;
    }

    .gold {
      color: #ffd100;
    }

    .recensement-list-entry {
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px dashed #444;
    }

    .recensement-list-entry:last-child {
      border-bottom: none;
    }

    .recensement-tabs {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      margin-bottom: 6px;
    }

    .rec-tab {
      padding: 4px 8px;
      border: 1px solid #555;
      border-bottom: none;
      background: #111;
      color: #ccc;
      cursor: pointer;
      font-size: 13px;
      border-radius: 4px 4px 0 0;
    }

    .rec-tab.active {
      background: #222;
      color: #ffd100;
      border-color: #caa500;
      font-weight: bold;
    }

    .rec-tab-content {
      border-top: 1px solid #caa500;
      padding-top: 8px;
    }

    #rec-search {
      width: 100%;
      max-width: 320px;
      padding: 4px;
      margin-top: 4px;
      background: #111;
      border: 1px solid #555;
      color: #fff;
    }

    #rec-search::placeholder {
      color: #888;
      font-size: 11px;
    }

    #rec-filter-job {
      margin-top: 2px;
    }

    #rec-artisans-list {
      font-size: 13px !important;
      text-align: left !important;
    }

    .artisan-job-section {
      margin-bottom: 12px !important;
      padding-bottom: 8px !important;
      border-bottom: 1px dashed #444 !important;
      text-align: left !important;
    }

    .artisan-job-section:last-child {
      border-bottom: none !important;
    }

    .artisan-job-header {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      justify-content: flex-start !important;
      gap: 10px !important;
      margin-bottom: 4px !important;
    }

    .artisan-job-icon {
      width: 64px !important;
      height: 64px !important;
      object-fit: contain !important;
      display: inline-block !important;
    }

    .artisan-job-title {
      display: inline-block !important;
      color: #ffd100 !important;
      font-weight: bold !important;
      font-size: 15px !important;
      margin: 0 !important;
      text-align: left !important;
    }

    .artisan-job-title::after {
      content: " :" !important;
    }

    .artisan-job-names {
      display: block !important;
      margin-left: 74px !important;
      line-height: 1.5 !important;
      text-align: left !important;
    }

    .artisan-name {
      cursor: pointer !important;
      text-decoration: underline !important;
    }

    .artisan-name:hover {
      color: #ffd100 !important;
    }

    .rec-note {
      color: #aaaaaa;
      font-style: italic;
      font-size: 11px;
    }
  </style>
</head>

<body>

  <button class="admin-btn" id="open-recensement">ðŸ“œ Recensement du quartier des Ã©toiles</button>

  <div class="map-container">
    <div class="map-inner">
      <img src="Map Logis Horde VIERGE.png" alt="Carte du Logis Horde">

      <!-- PARCELLES 0 Ã  54 (coordonnÃ©es Horde en %) -->
      <div class="plot" id="plot0"  style="left: 40.3%; top: 66.2%;">0</div>
      <div class="plot" id="plot1"  style="left: 64.3%; top: 78.5%;">1</div>
      <div class="plot" id="plot2"  style="left: 42.4%; top: 53.0%;">2</div>
      <div class="plot" id="plot3"  style="left: 60.2%; top: 78.5%;">3</div>
      <div class="plot" id="plot4"  style="left: 60.7%; top: 60.8%;">4</div>
      <div class="plot" id="plot5"  style="left: 62.6%; top: 79.7%;">5</div>
      <div class="plot" id="plot6"  style="left: 56.6%; top: 81.8%;">6</div>
      <div class="plot" id="plot7"  style="left: 60.8%; top: 83.0%;">7</div>
      <div class="plot" id="plot8"  style="left: 66.7%; top: 65.8%;">8</div>
      <div class="plot" id="plot9"  style="left: 40.8%; top: 58.7%;">9</div>
      <div class="plot" id="plot10"  style="left: 59.6%; top: 68.2%;">10</div>
      <div class="plot" id="plot11"  style="left: 44.0%; top: 72.1%;">11</div>
      <div class="plot" id="plot12"  style="left: 47.2%; top: 84.1%;">12</div>
      <div class="plot" id="plot13"  style="left: 65.3%; top: 76.1%;">13</div>
      <div class="plot" id="plot14"  style="left: 66.7%; top: 69.1%;">14</div>
      <div class="plot" id="plot15"  style="left: 67.7%; top: 49.0%;">15</div>
      <div class="plot" id="plot16"  style="left: 57.3%; top: 62.2%;">16</div>
      <div class="plot" id="plot17"  style="left: 44.2%; top: 75.4%;">17</div>
      <div class="plot" id="plot18"  style="left: 41.8%; top: 61.0%;">18</div>
      <div class="plot" id="plot19"  style="left: 58.1%; top: 87.7%;">19</div>
      <div class="plot" id="plot20"  style="left: 64.3%; top: 55.1%;">20</div>
      <div class="plot" id="plot21"  style="left: 59.9%; top: 58.3%;">21</div>
      <div class="plot" id="plot22"  style="left: 52.6%; top: 84.1%;">22</div>
      <div class="plot" id="plot23"  style="left: 67.2%; top: 52.3%;">23</div>
      <div class="plot" id="plot24"  style="left: 46.9%; top: 91.4%;">24</div>
      <div class="plot" id="plot25"  style="left: 46.7%; top: 54.2%;">25</div>
      <div class="plot" id="plot26"  style="left: 41.7%; top: 72.8%;">26</div>
      <div class="plot" id="plot27"  style="left: 49.5%; top: 69.4%;">27</div>
      <div class="plot" id="plot28"  style="left: 42.8%; top: 58.6%;">28</div>
      <div class="plot" id="plot29"  style="left: 54.8%; top: 70.3%;">29</div>
      <div class="plot" id="plot30"  style="left: 49.3%; top: 74.8%;">30</div>
      <div class="plot" id="plot31"  style="left: 61.1%; top: 49.0%;">31</div>
      <div class="plot" id="plot32"  style="left: 51.0%; top: 81.1%;">32</div>
      <div class="plot" id="plot33"  style="left: 45.1%; top: 70.1%;">33</div>
      <div class="plot" id="plot34"  style="left: 58.0%; top: 66.1%;">34</div>
      <div class="plot" id="plot35"  style="left: 71.4%; top: 56.0%;">35</div>
      <div class="plot" id="plot36"  style="left: 47.6%; top: 56.5%;">36</div>
      <div class="plot" id="plot37"  style="left: 55.2%; top: 89.6%;">37</div>
      <div class="plot" id="plot38"  style="left: 69.8%; top: 53.8%;">38</div>
      <div class="plot" id="plot39"  style="left: 70.0%; top: 45.5%;">39</div>
      <div class="plot" id="plot40"  style="left: 54.3%; top: 73.9%;">40</div>
      <div class="plot" id="plot41"  style="left: 48.2%; top: 65.7%;">41</div>
      <div class="plot" id="plot42"  style="left: 69.6%; top: 57.2%;">42</div>
      <div class="plot" id="plot43"  style="left: 46.0%; top: 81.9%;">43</div>
      <div class="plot" id="plot44"  style="left: 63.4%; top: 52.5%;">44</div>
      <div class="plot" id="plot45"  style="left: 61.2%; top: 54.0%;">45</div>
      <div class="plot" id="plot46"  style="left: 65.1%; top: 44.9%;">46</div>
      <div class="plot" id="plot47"  style="left: 55.1%; top: 64.8%;">47</div>
      <div class="plot" id="plot48"  style="left: 56.5%; top: 68.4%;">48</div>
      <div class="plot" id="plot49"  style="left: 54.4%; top: 86.5%;">49</div>
      <div class="plot" id="plot50"  style="left: 47.1%; top: 72.9%;">50</div>
      <div class="plot" id="plot51"  style="left: 58.6%; top: 82.3%;">51</div>
      <div class="plot" id="plot52"  style="left: 67.0%; top: 59.5%;">52</div>
      <div class="plot" id="plot53"  style="left: 65.2%; top: 60.1%;">53</div>
      <div class="plot" id="plot54"  style="left: 44.5%; top: 80.1%;">54</div>

      <!-- MARKERS HORDE -->
      <div class="marker marker-portal"
           style="left: 53.9%; top: 49.4%;"
           data-title="Portail vers Orgrimmar"
           data-text="TÃ©lÃ©portation vers Orgrimmar"></div>

      <div class="marker marker-flight"
           style="left: 54.9%; top: 51.2%;"
           data-title="MaÃ®tre de vol"
           data-text="Portail d'entrÃ©e"></div>

      <div class="marker marker-flight"
           style="left: 53.7%; top: 59.8%;"
           data-title="MaÃ®tre de vol"
           data-text="Les communs"></div>

      <div class="marker marker-flight"
           style="left: 42.7%; top: 55.9%;"
           data-title="MaÃ®tre de vol"
           data-text="Havre de Totem-Runique nord"></div>

      <div class="marker marker-flight"
           style="left: 47.8%; top: 70.1%;"
           data-title="MaÃ®tre de vol"
           data-text="Havre de Totem-Runique sud"></div>

      <div class="marker marker-flight"
           style="left: 66.3%; top: 56.5%;"
           data-title="MaÃ®tre de vol"
           data-text="Hautes-Terres de la combe Ã‰pineuse"></div>

      <div class="marker marker-flight"
           style="left: 59.2%; top: 72.1%;"
           data-title="MaÃ®tre de vol"
           data-text="La FlorÃ©pine"></div>

      <div class="marker marker-flight"
           style="left: 68.1%; top: 75.7%;"
           data-title="MaÃ®tre de vol"
           data-text="Hauts-fonds de Crocs-SalÃ©s est"></div>

      <div class="marker marker-flight"
           style="left: 52.7%; top: 82.0%;"
           data-title="MaÃ®tre de vol"
           data-text="Les pitons"></div>

      <div class="legend-box">
        <div class="legend-header">LÃ©gende</div>

        <label class="legend-item">
          <input type="checkbox" id="toggle-free" checked />
          <span class="legend-icon legend-free"></span>
          <span>Emplacements libres</span>
        </label>

        <label class="legend-item">
          <input type="checkbox" id="toggle-taken" checked />
          <span class="legend-icon legend-taken"></span>
          <span>Emplacements occupÃ©s</span>
        </label>

        <label class="legend-item">
          <input type="checkbox" id="toggle-flight" checked />
          <span class="legend-icon legend-flight"></span>
          <span>MaÃ®tres de vol</span>
        </label>

        <label class="legend-item">
          <input type="checkbox" id="toggle-portal" checked />
          <span class="legend-icon legend-portal"></span>
          <span>Portail vers Orgrimmar</span>
        </label>

        <div class="legend-separator"></div>

        <div class="legend-available" id="available-wrapper">
          Emplacements disponibles : <span id="available-count">--</span>
        </div>
      </div>

      <!-- POPUP RECENSEMENT -->
      <div id="recensement-popup" class="recensement-popup">
        <div class="recensement-header">
          <span class="recensement-title">ðŸ“œ Recensement du quartier des Ã©toiles</span>
          <button class="recensement-close" id="recensement-close">X</button>
        </div>
        <div class="recensement-content">
          <p><span class="gold">Habitants total :</span> <span id="rec-total">--</span></p>
          <p><span class="gold">AnciennetÃ© moyenne :</span> <span id="rec-average">--</span></p>

          <p>
            <span class="gold">Trier par :</span>
            <select id="rec-sort">
              <option value="id">NumÃ©ro d'emplacement</option>
              <option value="name">Nom de rÃ©sident</option>
              <option value="anciennete">AnciennetÃ©</option>
            </select>
          </p>

          <p>
            <span class="gold">Filtrer par mÃ©tier :</span>
            <select id="rec-filter-job"></select>
          </p>

          <p>
            <span class="gold">Recherche :</span><br>
            <input id="rec-search" type="text"
                   placeholder="Nom, numÃ©ro #, mÃ©tier, forgeron, mineur, pÃªcheur..." />
          </p>

          <div class="recensement-tabs">
            <div class="rec-tab active" id="tab-residents">RÃ©sidents</div>
            <div class="rec-tab" id="tab-artisans">Artisans</div>
          </div>

          <div id="rec-residents-content" class="rec-tab-content">
            <div id="rec-list"></div>
          </div>

          <div id="rec-artisans-content" class="rec-tab-content" style="display:none;">
            <div id="rec-artisans-list"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <button class="admin-btn" id="open-admin">ðŸ”‘ Mode Administrateur</button>

  <div class="admin-popup" id="admin-popup">
    <h3>AccÃ¨s administrateur</h3>
    <input type="password" id="admin-pass" placeholder="Mot de passe..." />
    <label style="display:block;margin:6px 0;">
      <input type="checkbox" id="show-pass"> Afficher le mot de passe
    </label>
    <button id="admin-validate">Valider</button>
    <button type="button" onclick="document.getElementById('admin-popup').style.display='none'">
      Annuler
    </button>
  </div>

  <div class="panel" id="admin-panel">
    <h2>Gestion des rÃ©sidents</h2>

    <form id="owner-form">
      <div class="form-row">
        <label for="plot-select">Emplacement :</label>
        <select id="plot-select"></select>
      </div>

      <div class="form-row">
        <label for="owner-name">Nom :</label>
        <input type="text" id="owner-name" placeholder="Nom du rÃ©sident" />
      </div>

      <div class="form-row">
        <label>Genre :</label>
        <select id="owner-gender">
          <option value="">(non prÃ©cisÃ©)</option>
          <option value="f">FÃ©minin</option>
          <option value="m">Masculin</option>
        </select>
      </div>

      <div class="form-row">
        <label>Date d'arrivÃ©e :</label>
        <select id="owner-day"></select>
        <select id="owner-month"></select>
        <select id="owner-year"></select>
      </div>

      <div class="form-row">
        <label>MÃ©tiers (jusqu'Ã  5) :</label>
        <select id="job1"></select>
        <select id="job2"></select>
        <select id="job3"></select>
        <select id="job4"></select>
        <select id="job5"></select>
      </div>

      <div class="form-row">
        <label for="owner-note">Note interne :</label>
        <textarea id="owner-note" rows="2" cols="40"
          placeholder="Visible uniquement en mode administrateur"></textarea>
      </div>

      <div class="form-row">
        <button type="submit">Enregistrer / mettre Ã  jour</button>
        <button type="button" id="delete-owner">Supprimer le rÃ©sident</button>
        <button type="button" id="generate-deed">GÃ©nÃ©rer un acte de propriÃ©tÃ©</button>
      </div>

      <div class="form-row">
        <button type="button" id="backup-save">ðŸ’¾ Enregistrer une sauvegarde</button>
        <button type="button" id="backup-load">ðŸ“‚ Charger une sauvegarde</button>
        <input type="file" id="backup-file" accept=".json" style="display:none" />
      </div>

      <button type="button" class="disconnect-btn" id="admin-disconnect">
        ðŸ”“ Se dÃ©connecter du mode administrateur
      </button>
    </form>
  </div>

  <div id="tooltip" class="tooltip">
    <div class="tooltip-title"></div>
    <div class="tooltip-body"></div>
  </div>

  <script>
    /* SHA-256 moderne via l'API du navigateur */
    async function sha256(str) {
      if (!window.crypto || !window.crypto.subtle) {
        throw new Error("SHA-256 non supportÃ© par ce navigateur.");
      }
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await window.crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
      return hashHex;
    }

    // Mot de passe Horde : "UnBLUEteStLoG2778"
    const ADMIN_HASH = "f7b4bb78d3b199e9daea8db7f38d7301dcf5262a6cdc38737535bfc282a3d049";
    const OWNERS_KEY = "logis_enclave_horde";
    const ADMIN_FLAG = "logis_enclave_admin";
    const DEED_BASE_SRC = "Acte_propriete_base.png";

    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbyH6rWnXI9rywmN88XdRKF28fnpZ7zdo8XQyCL5iXBMmjkbhUOMUCMna1VhQpV3aQoKFg/exec";

    function loadJSON(key) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveJSON(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch {}
    }

    let owners = loadJSON(OWNERS_KEY);

    async function fetchOwnersFromServer() {
      if (!SHEET_API_URL) return;
      try {
        const resp = await fetch(SHEET_API_URL);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (data && data.owners) {
          owners = data.owners;
          saveJSON(OWNERS_KEY, owners);
          updatePlotColors();
          applyVisibilityFilters();
          updateAvailableCount();
        }
      } catch (err) {
        console.warn("Impossible de charger les donnÃ©es distantes, utilisation du cache local.", err);
      }
    }

    async function syncOwnersToServer() {
      if (!SHEET_API_URL) return;
      try {
        await fetch(SHEET_API_URL, {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify({ action: "saveAll", owners })
        });
      } catch (err) {
        console.error("Erreur de synchronisation avec la feuille Google.", err);
        alert(
          "Attention : la synchronisation avec la feuille Google a Ã©chouÃ©.\n" +
          "Les donnÃ©es sont quand mÃªme sauvegardÃ©es localement sur cet appareil."
        );
      }
    }

    const tooltip = document.getElementById("tooltip");
    const tooltipTitle = tooltip.querySelector(".tooltip-title");
    const tooltipBody = tooltip.querySelector(".tooltip-body");

    function getJobLabel(code, gender) {
      if (!code) return "";
      switch (code) {
        case "alchimie":       return "Alchimie";
        case "calligraphie":   return "Calligraphie";
        case "couture":        return "Couture";
        case "cuisine":        return "Cuisine";
        case "enchantement":   return "Enchantement";
        case "forge":          return "Forge";
        case "ingenierie":     return "IngÃ©nierie";
        case "joaillerie":     return "Joaillerie";
        case "travail_du_cuir":return "Travail du cuir";
        case "peche":          return "PÃªche";
        case "mine":           return "Minage";
        case "herboristerie":  return "Herboristerie";
        case "depecage":       return "DÃ©peÃ§age";
        case "archeologie":    return "ArchÃ©ologie";
        default:               return code;
      }
    }

    const JOB_ICONS = {
      "alchimie":       "icone_alchimie.png",
      "calligraphie":   "icone_calligraphie.png",
      "couture":        "icone_couture.png",
      "cuisine":        "icone_cuisine.png",
      "enchantement":   "icone_enchantement.png",
      "forge":          "icone_forge.png",
      "ingenierie":     "icone_ingenierie.png",
      "joaillerie":     "icone_joaillerie.png",
      "travail_du_cuir":"icone_travail_du_cuir.png",
      "peche":          "icone_peche.png",
      "mine":           "icone_mine.png",
      "herboristerie":  "icone_herboristerie.png",
      "depecage":       "icone_depecage.png",
      "archeologie":    "icone_archeologie.png"
    };

    const JOB_SYNONYMS = {
      "forgeron":     "forge",
      "forgeronne":   "forge",
      "mineur":       "mine",
      "mineuse":      "mine",
      "pÃªcheur":      "peche",
      "pecheur":      "peche",
      "pÃªcheuse":     "peche",
      "pecheuse":     "peche",
      "herboriste":   "herboristerie",
      "herbo":        "herboristerie",
      "dÃ©peceur":     "depecage",
      "depeceur":     "depecage",
      "dÃ©peceuse":    "depecage",
      "depeceuse":    "depecage",
      "archÃ©ologie":  "archeologie",
      "archeologie":  "archeologie",
      "archÃ©ologue":  "archeologie",
      "archeologue":  "archeologie"
    };

    function updatePlotColors() {
      document.querySelectorAll(".plot").forEach(plot => {
        const id = parseInt(plot.textContent, 10);
        plot.classList.toggle("taken", !!owners[id]);
      });
    }

    function showOwnerTooltipById(id, rect) {
      const o = owners[id];
      if (!o) {
        tooltip.style.display = "none";
        return;
      }
      const g = o.gender || "";
      let t = "RÃ©sidentÂ·e";
      if (g === "f") t = "RÃ©sidente";
      if (g === "m") t = "RÃ©sident";

      tooltipTitle.textContent = o.name;

      const lines = [];

      // Ligne "rÃ©sident depuis"
      lines.push(`${t} depuis le ${escapeHtml(o.since)}`);

      // MÃ©tiers
      if (o.jobs && o.jobs.length > 0) {
        const labels = o.jobs.map(j => getJobLabel(j, g)).filter(Boolean);
        if (labels.length > 0) {
          lines.push(
            `<span class="tooltip-label">MÃ©tiers :</span> ` +
            labels.map(escapeHtml).join(", ")
          );
        }
      }

      // Parcelle
      lines.push(
        `<span class="tooltip-label">Parcelle :</span> #${id}`
      );

      tooltipBody.innerHTML = lines.join("<br>");

      tooltip.style.top  = (rect.top + window.scrollY - 10) + "px";
      tooltip.style.left = (rect.left + window.scrollX + rect.width / 2) + "px";
      tooltip.style.transform = "translate(-50%, -100%)";
      tooltip.style.display = "block";
    }

    document.querySelectorAll(".plot").forEach(plot => {
      const id = parseInt(plot.textContent, 10);

      plot.addEventListener("mouseenter", () => {
        const o = owners[id];
        if (!o) {
          tooltip.style.display = "none";
          return;
        }
        const r = plot.getBoundingClientRect();
        showOwnerTooltipById(id, r);
      });

      plot.addEventListener("mouseleave", () => {
        tooltip.style.display = "none";
      });
    });

    document.querySelectorAll(".marker").forEach(marker => {
      marker.addEventListener("mouseenter", () => {
        const title = marker.getAttribute("data-title");
        const text  = marker.getAttribute("data-text");
        tooltipTitle.textContent = title || "";
        tooltipBody.textContent = text || "";
        const r = marker.getBoundingClientRect();
        tooltip.style.top  = (r.top + window.scrollY - 10) + "px";
        tooltip.style.left = (r.left + window.scrollX + r.width / 2) + "px";
        tooltip.style.transform = "translate(-50%, -100%)";
        tooltip.style.display = "block";
      });
      marker.addEventListener("mouseleave", () => {
        tooltip.style.display = "none";
      });
    });

    const chkFree   = document.getElementById("toggle-free");
    const chkTaken  = document.getElementById("toggle-taken");
    const chkFlight = document.getElementById("toggle-flight");
    const chkPortal = document.getElementById("toggle-portal");

    function applyVisibilityFilters() {
      const showFree   = chkFree.checked;
      const showTaken  = chkTaken.checked;
      const showFlight = chkFlight.checked;
      const showPortal = chkPortal.checked;

      document.querySelectorAll(".plot").forEach(plot => {
        const isTaken = plot.classList.contains("taken");
        let visible = true;
        if (isTaken && !showTaken) visible = false;
        if (!isTaken && !showFree) visible = false;
        plot.style.display = visible ? "flex" : "none";
      });

      document.querySelectorAll(".marker-flight").forEach(m => {
        m.style.display = showFlight ? "block" : "none";
      });

      document.querySelectorAll(".marker-portal").forEach(m => {
        m.style.display = showPortal ? "block" : "none";
      });
    }

    chkFree.addEventListener("change", applyVisibilityFilters);
    chkTaken.addEventListener("change", applyVisibilityFilters);
    chkFlight.addEventListener("change", applyVisibilityFilters);
    chkPortal.addEventListener("change", applyVisibilityFilters);

    function updateAvailableCount() {
      const totalPlots = document.querySelectorAll(".plot").length;
      let taken = Object.keys(owners).length;
      const free = totalPlots - taken;
      document.getElementById("available-count").textContent = free;
    }

    const availableWrapper = document.getElementById("available-wrapper");
    availableWrapper.addEventListener("mouseenter", () => {
      const totalPlots = document.querySelectorAll(".plot").length;
      const freeIds = [];
      for (let i = 0; i < totalPlots; i++) {
        if (!owners[i]) freeIds.push(i);
      }
      tooltipTitle.textContent = "Emplacements libres";
      tooltipBody.textContent = freeIds.length ? freeIds.join(", ") : "Aucun";
      const r = availableWrapper.getBoundingClientRect();
      tooltip.style.top  = (r.top + window.scrollY - 10) + "px";
      tooltip.style.left = (r.left + window.scrollX + r.width / 2) + "px";
      tooltip.style.transform = "translate(-50%, -100%)";
      tooltip.style.display = "block";
    });
    availableWrapper.addEventListener("mouseleave", () => {
      tooltip.style.display = "none";
    });

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function(ch) {
        return ({
          '&':'&amp;',
          '<':'&lt;',
          '>':'&gt;',
          '"':'&quot;',
          '\'':'&#039;'
        }[ch]);
      });
    }

    const recBtn = document.getElementById("open-recensement");
    const recPopup = document.getElementById("recensement-popup");
    const recClose = document.getElementById("recensement-close");
    const recSortSelect = document.getElementById("rec-sort");
    const recSearchInput = document.getElementById("rec-search");
    const recFilterJobSelect = document.getElementById("rec-filter-job");
    const tabResidents = document.getElementById("tab-residents");
    const tabArtisans  = document.getElementById("tab-artisans");
    const recResidentsContent = document.getElementById("rec-residents-content");
    const recArtisansContent  = document.getElementById("rec-artisans-content");

    ["wheel", "mousedown"].forEach(evt => {
      recPopup.addEventListener(evt, (e) => {
        e.stopPropagation();
      }, { passive: true });
    });

    let currentRecTab = "residents";

    function setRecTab(tab) {
      currentRecTab = tab;

      tabResidents.classList.remove("active");
      tabArtisans.classList.remove("active");
      recResidentsContent.style.display = "none";
      recArtisansContent.style.display  = "none";

      if (tab === "residents") {
        tabResidents.classList.add("active");
        recResidentsContent.style.display = "block";
      } else if (tab === "artisans") {
        tabArtisans.classList.add("active");
        recArtisansContent.style.display = "block";
      }
    }

    tabResidents.addEventListener("click", () => {
      setRecTab("residents");
    });
    tabArtisans.addEventListener("click", () => {
      setRecTab("artisans");
    });

    function updateRecensement() {
      const listDiv = document.getElementById("rec-list");
      const artisansDiv = document.getElementById("rec-artisans-list");
      const totalSpan = document.getElementById("rec-total");
      const avgSpan = document.getElementById("rec-average");

      const entries = [];
      const now = Date.now();
      let sumDays = 0;
      let countDays = 0;

      for (const id in owners) {
        const o = owners[id];
        const numericId = parseInt(id, 10);
        entries.push({
          id: numericId,
          name: o.name,
          gender: o.gender || "",
          since: o.since,
          jobs: o.jobs || [],
          timestamp: o.timestamp || null,
          note: o.note || ""
        });
      }

      totalSpan.textContent = entries.length;

      entries.forEach(e => {
        if (typeof e.timestamp === "number" && !isNaN(e.timestamp)) {
          const diff = now - e.timestamp;
          const days = diff / (1000 * 60 * 60 * 24);
          if (days >= 0) {
            sumDays += days;
            countDays++;
          }
        }
      });

      if (countDays === 0) {
        avgSpan.textContent = "â€”";
      } else {
        const avg = Math.round(sumDays / countDays);
        avgSpan.textContent = avg + " jours";
      }

      const query = recSearchInput ? recSearchInput.value.trim().toLowerCase() : "";
      const filterJob = recFilterJobSelect ? recFilterJobSelect.value : "";
      const adminMode = localStorage.getItem(ADMIN_FLAG) === "true";

      function matchesSearch(entry) {
        if (!query) return true;

        const q = query;
        const name = (entry.name || "").toLowerCase();
        if (name.includes(q)) return true;

        if (String(entry.id).includes(q)) return true;

        // mÃ©tiers
        let jobLabelMatch = false;
        (entry.jobs || []).forEach(j => {
          const label = getJobLabel(j, entry.gender).toLowerCase();
          if (label.includes(q)) jobLabelMatch = true;
        });
        if (jobLabelMatch) return true;

        // synonymes de mÃ©tiers
        for (const word in JOB_SYNONYMS) {
          if (q.includes(word)) {
            const jobCode = JOB_SYNONYMS[word];
            if ((entry.jobs || []).includes(jobCode)) return true;
          }
        }

        return false;
      }

      let residentsEntries = entries.slice();
      const sortMode = recSortSelect ? recSortSelect.value : "id";

      if (sortMode === "name") {
        residentsEntries.sort((a, b) =>
          (a.name || "").localeCompare(b.name || "", "fr", { sensitivity: "base" })
        );
      } else if (sortMode === "anciennete") {
        residentsEntries.sort((a, b) => {
          const ta = (typeof a.timestamp === "number") ? a.timestamp : Infinity;
          const tb = (typeof b.timestamp === "number") ? b.timestamp : Infinity;
          return ta - tb;
        });
      } else {
        residentsEntries.sort((a, b) => a.id - b.id);
      }

      // --- Onglet RÃ©sidents ---
      listDiv.innerHTML = "";
      residentsEntries.forEach(e => {
        if (!matchesSearch(e)) return;

        if (filterJob === "none") {
          if (e.jobs && e.jobs.length) return;
        } else if (filterJob) {
          if (!(e.jobs || []).includes(filterJob)) return;
        }

        const div = document.createElement("div");
        div.className = "recensement-list-entry";
        const g = e.gender === "f" ? "RÃ©sidente" :
                  e.gender === "m" ? "RÃ©sident" : "RÃ©sidentÂ·e";
        const jobLabels = (e.jobs || [])
          .map(code => getJobLabel(code, e.gender))
          .filter(Boolean);

        let html =
          `<span class="gold">#${e.id}</span> â€” <b>${escapeHtml(e.name)}</b>` +
          `<br>${g} depuis le ${escapeHtml(e.since)}`;
        if (jobLabels.length > 0) {
          html += `<br>MÃ©tiers : ${jobLabels.map(escapeHtml).join(", ")}`;
        }
        if (adminMode && e.note) {
          html += `<br><span class="rec-note">Note interne : ${escapeHtml(e.note)}</span>`;
        }

        div.innerHTML = html;
        listDiv.appendChild(div);
      });

      // --- Onglet Artisans ---
      artisansDiv.innerHTML = "";

      const jobsMap = {};
      residentsEntries.forEach(e => {
        (e.jobs || []).forEach(j => {
          if (!jobsMap[j]) {
            jobsMap[j] = [];
          }
          jobsMap[j].push(e);
        });
      });

      const jobCodes = Object.keys(jobsMap).sort((a, b) => {
        const la = getJobLabel(a, "");
        const lb = getJobLabel(b, "");
        return la.localeCompare(lb, "fr", { sensitivity: "base" });
      });

      jobCodes.forEach(code => {
        const label = getJobLabel(code, "");
        if (!label) return;
        const list = jobsMap[code];

        const filtered = list.filter(e => {
          if (!matchesSearch(e)) return false;
          if (filterJob === "none") {
            if (e.jobs && e.jobs.length) return false;
          } else if (filterJob) {
            if (!(e.jobs || []).includes(filterJob)) return false;
          }
          return true;
        });
        if (filtered.length === 0) return;

        const section = document.createElement("div");
        section.className = "artisan-job-section";

        const header = document.createElement("div");
        header.className = "artisan-job-header";

        const icon = document.createElement("img");
        icon.className = "artisan-job-icon";
        icon.src = JOB_ICONS[code] || "";
        icon.alt = label;

        const titleSpan = document.createElement("span");
        titleSpan.className = "artisan-job-title";
        titleSpan.textContent = label;

        header.appendChild(icon);
        header.appendChild(titleSpan);

        const namesDiv = document.createElement("div");
        namesDiv.className = "artisan-job-names";

        filtered.forEach((e, idx) => {
          const span = document.createElement("span");
          span.className = "artisan-name";
          span.textContent = e.name;
          span.dataset.id = e.id;

          span.addEventListener("mouseenter", () => {
            const rect = span.getBoundingClientRect();
            showOwnerTooltipById(e.id, rect);
          });
          span.addEventListener("mouseleave", () => {
            tooltip.style.display = "none";
          });

          span.addEventListener("click", () => {
            recPopup.style.display = "none";
            tooltip.style.display = "none";
            focusOnPlot(e.id);
          });

          namesDiv.appendChild(span);
          if (idx < filtered.length - 1) {
            namesDiv.appendChild(document.createTextNode(", "));
          }
        });

        section.appendChild(header);
        section.appendChild(namesDiv);
        artisansDiv.appendChild(section);
      });
    }

    if (recSortSelect) {
      recSortSelect.addEventListener("change", () => {
        updateRecensement();
      });
    }

    if (recSearchInput) {
      recSearchInput.addEventListener("input", () => {
        updateRecensement();
      });
    }

    if (recFilterJobSelect) {
      recFilterJobSelect.addEventListener("change", () => {
        updateRecensement();
      });
    }

    recBtn.addEventListener("click", () => {
      setRecTab("residents");
      updateRecensement();
      recPopup.style.display = "block";
    });

    recClose.addEventListener("click", () => {
      recPopup.style.display = "none";
      tooltip.style.display = "none";
    });

    const panel        = document.getElementById("admin-panel");
    const selectPlot   = document.getElementById("plot-select");
    const inputName    = document.getElementById("owner-name");
    const selectGender = document.getElementById("owner-gender");
    const daySelect    = document.getElementById("owner-day");
    const monthSelect  = document.getElementById("owner-month");
    const yearSelect   = document.getElementById("owner-year");
    const job1         = document.getElementById("job1");
    const job2         = document.getElementById("job2");
    const job3         = document.getElementById("job3");
    const job4         = document.getElementById("job4");
    const job5         = document.getElementById("job5");
    const noteInput    = document.getElementById("owner-note");
    const deleteBtn    = document.getElementById("delete-owner");
    const generateDeedBtn = document.getElementById("generate-deed");
    const backupSaveBtn = document.getElementById("backup-save");
    const backupLoadBtn = document.getElementById("backup-load");
    const backupFileInput = document.getElementById("backup-file");

    (function initPlotSelect() {
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "-- Choisir un emplacement --";
      defaultOption.disabled = true;
      defaultOption.selected = true;
      selectPlot.appendChild(defaultOption);
      for (let i = 0; i <= 54; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = i;
        selectPlot.appendChild(opt);
      }
    })();

    (function initDateSelects() {
      const optD = document.createElement("option");
      optD.value = "";
      optD.textContent = "Jour";
      optD.disabled = true;
      optD.selected = true;
      daySelect.appendChild(optD);
      for (let d = 1; d <= 31; d++) {
        const o = document.createElement("option");
        o.value = d;
        o.textContent = d;
        daySelect.appendChild(o);
      }

      const months = [
        "janvier","fÃ©vrier","mars","avril","mai","juin",
        "juillet","aoÃ»t","septembre","octobre","novembre","dÃ©cembre"
      ];
      const optM = document.createElement("option");
      optM.value = "";
      optM.textContent = "Mois";
      optM.disabled = true;
      optM.selected = true;
      monthSelect.appendChild(optM);
      months.forEach((m, idx) => {
        const o = document.createElement("option");
        o.value = idx;
        o.textContent = m;
        monthSelect.appendChild(o);
      });

      const optY = document.createElement("option");
      optY.value = "";
      optY.textContent = "AnnÃ©e";
      optY.disabled = true;
      optY.selected = true;
      yearSelect.appendChild(optY);
      for (let y = 2024; y <= 2035; y++) {
        const o = document.createElement("option");
        o.value = y;
        o.textContent = y;
        yearSelect.appendChild(o);
      }
    })();

    const JOB_OPTIONS = [
      { value: "",             label: "(Rien)" },
      { value: "alchimie",     label: "Alchimie" },
      { value: "calligraphie", label: "Calligraphie" },
      { value: "couture",      label: "Couture" },
      { value: "cuisine",      label: "Cuisine" },
      { value: "enchantement", label: "Enchantement" },
      { value: "forge",        label: "Forge" },
      { value: "ingenierie",   label: "IngÃ©nierie" },
      { value: "joaillerie",   label: "Joaillerie" },
      { value: "travail_du_cuir", label: "Travail du cuir" },
      { value: "peche",        label: "PÃªche" },
      { value: "mine",         label: "Minage" },
      { value: "herboristerie",label: "Herboristerie" },
      { value: "depecage",     label: "DÃ©peÃ§age" },
      { value: "archeologie",  label: "ArchÃ©ologie" }
    ];

    function fillJobSelect(sel) {
      JOB_OPTIONS.forEach(j => {
        const o = document.createElement("option");
        o.value = j.value;
        o.textContent = j.label;
        sel.appendChild(o);
      });
    }

    fillJobSelect(job1);
    fillJobSelect(job2);
    fillJobSelect(job3);
    fillJobSelect(job4);
    fillJobSelect(job5);

    (function initRecFilterJobs() {
      if (!recFilterJobSelect) return;
      recFilterJobSelect.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "(Tous les mÃ©tiers)";
      recFilterJobSelect.appendChild(optAll);

      const optNone = document.createElement("option");
      optNone.value = "none";
      optNone.textContent = "Sans mÃ©tier";
      recFilterJobSelect.appendChild(optNone);

      JOB_OPTIONS.forEach(j => {
        if (!j.value) return;
        const o = document.createElement("option");
        o.value = j.value;
        o.textContent = j.label;
        recFilterJobSelect.appendChild(o);
      });
    })();

    function refreshJobDropdowns() {
      const selects = [job1, job2, job3, job4, job5];

      const chosen = selects
        .map(s => s.value)
        .filter(v => v !== "");

      selects.forEach(sel => {
        const current = sel.value;

        Array.from(sel.options).forEach(opt => {
          const val = opt.value;

          if (val === "") {
            opt.disabled = false;
            return;
          }

          if (chosen.includes(val) && val !== current) {
            opt.disabled = true;
          } else {
            opt.disabled = false;
          }
        });
      });
    }

    [job1, job2, job3, job4, job5].forEach(sel => {
      sel.addEventListener("change", refreshJobDropdowns);
    });

    refreshJobDropdowns();

    function refreshForm(id) {
      const o = owners[id];
      if (!o) {
        inputName.value = "";
        selectGender.value = "";
        daySelect.value = "";
        monthSelect.value = "";
        yearSelect.value = "";
        job1.value = "";
        job2.value = "";
        job3.value = "";
        job4.value = "";
        job5.value = "";
        noteInput.value = "";
        refreshJobDropdowns();
        return;
      }
      inputName.value = o.name || "";
      selectGender.value = o.gender || "";
      if (typeof o.day === "number") daySelect.value = o.day;
      else daySelect.value = "";
      if (typeof o.month === "number") monthSelect.value = o.month;
      else daySelect.value = "";
      if (typeof o.year === "number") yearSelect.value = o.year;
      else yearSelect.value = "";

      const jobs = o.jobs || [];
      job1.value = jobs[0] || "";
      job2.value = jobs[1] || "";
      job3.value = jobs[2] || "";
      job4.value = jobs[3] || "";
      job5.value = jobs[4] || "";

      noteInput.value = o.note || "";
      refreshJobDropdowns();
    }

    selectPlot.addEventListener("change", () => {
      const id = parseInt(selectPlot.value, 10);
      if (!isNaN(id)) {
        refreshForm(id);
      }
    });

    document.getElementById("owner-form").addEventListener("submit", e => {
      e.preventDefault();
      const id = parseInt(selectPlot.value, 10);
      const name = inputName.value.trim();
      const gender = selectGender.value;
      const dayVal = daySelect.value;
      const monthVal = monthSelect.value;
      const yearVal = yearSelect.value;

      if (isNaN(id)) {
        alert("Merci de choisir un emplacement.");
        return;
      }
      if (!name) {
        alert("Merci de renseigner un nom.");
        return;
      }
      if (!dayVal || !monthVal || !yearVal) {
        alert("Merci de renseigner une date complÃ¨te (jour, mois, annÃ©e).");
        return;
      }

      const day = parseInt(dayVal, 10);
      const monthIndex = parseInt(monthVal, 10);
      const year = parseInt(yearVal, 10);
      const monthLabel = monthSelect.options[monthSelect.selectedIndex].textContent;
      const since = day + " " + monthLabel + " " + year;
      const timestamp = new Date(year, monthIndex, day).getTime();

      const jobs = [];
      [job1, job2, job3, job4, job5].forEach(sel => {
        const val = sel.value;
        if (val && !jobs.includes(val)) {
          jobs.push(val);
        }
      });

      const note = noteInput.value.trim();

      owners[id] = {
        name,
        gender,
        since,
        timestamp,
        day,
        month: monthIndex,
        year,
        jobs,
        note
      };

      saveJSON(OWNERS_KEY, owners);
      updatePlotColors();
      applyVisibilityFilters();
      updateAvailableCount();
      syncOwnersToServer();
      alert("RÃ©sident enregistrÃ© !");
    });

    deleteBtn.addEventListener("click", () => {
      const id = parseInt(selectPlot.value, 10);
      if (isNaN(id)) {
        alert("Merci de choisir un emplacement.");
        return;
      }
      if (!owners[id]) {
        alert("Aucun rÃ©sident sur cette parcelle.");
        return;
      }
      if (!confirm("Supprimer ce rÃ©sident ?")) return;
      delete owners[id];
      saveJSON(OWNERS_KEY, owners);
      updatePlotColors();
      applyVisibilityFilters();
      updateAvailableCount();
      refreshForm(id);
      syncOwnersToServer();
      alert("RÃ©sident supprimÃ©.");
    });

    generateDeedBtn.addEventListener("click", () => {
      const id = parseInt(selectPlot.value, 10);
      if (isNaN(id)) {
        alert("Merci de choisir un emplacement avant de gÃ©nÃ©rer l'acte.");
        return;
      }

      const o = owners[id];
      if (!o) {
        alert("Aucun rÃ©sident enregistrÃ© sur cet emplacement.");
        return;
      }

      const ownerName = o.name;
      const plotNumber = "#" + id;

      let dateStr;
      if (typeof o.day === "number" && typeof o.month === "number" && typeof o.year === "number") {
        const months = [
          "janvier","fÃ©vrier","mars","avril","mai","juin",
          "juillet","aoÃ»t","septembre","octobre","novembre","dÃ©cembre"
        ];
        const monthLabel = months[o.month] || "";
        dateStr = o.day + " " + monthLabel + " " + o.year;
      } else {
        const now = new Date();
        dateStr = now.toLocaleDateString("fr-FR", {
          day: "numeric",
          month: "long",
          year: "numeric",
        });
      }

      const IMG_W = 6144;
      const IMG_H = 4096;

      const NAME_X_PCT = (3617 / IMG_W) * 100;
      const NAME_Y_PCT = (1570 / IMG_H) * 100;

      const PLOT_X_PCT = (5395 / IMG_W) * 100;
      const PLOT_Y_PCT = (1766 / IMG_H) * 100;

      const DATE_X_PCT = (3144 / IMG_W) * 100;
      const DATE_Y_PCT = (3388 / IMG_H) * 100;

      const w = window.open("");
      if (!w) {
        alert("Impossible d'ouvrir la fenÃªtre de prÃ©visualisation (popup bloquÃ© ?).");
        return;
      }

      w.document.write(`
        <!DOCTYPE html>
        <html lang="fr">
        <head>
          <meta charset="UTF-8" />
          <title>Acte de propriÃ©tÃ© - Enclave du Vent d'Or</title>
          <style>
            @page { margin: 0; }
            html, body {
              margin: 0;
              padding: 0;
              background: #000;
              height: 100%;
            }
            body {
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .wrapper {
              position: relative;
              width: 1024px;
              height: ${1024 * (IMG_H / IMG_W)}px;
            }
            .bg-img {
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              object-fit: fill;
              z-index: 0;
            }
            .txt {
              position: absolute;
              z-index: 1;
              font-family: "Caladea", "Times New Roman", serif;
              color: #000000;
              font-size: 24px;
              white-space: nowrap;
            }
            .name {
              left: ${NAME_X_PCT}%;
              top: ${NAME_Y_PCT}%;
              transform: translate(0, -50%);
            }
            .plot {
              left: ${PLOT_X_PCT}%;
              top: ${PLOT_Y_PCT}%;
              transform: translate(0, -50%);
            }
            .date {
              left: ${DATE_X_PCT}%;
              top: ${DATE_Y_PCT}%;
              transform: translate(0, -50%);
            }
          </style>
        </head>
        <body>
          <div class="wrapper">
            <img id="bg-acte" class="bg-img" src="${DEED_BASE_SRC}" alt="Acte de propriÃ©tÃ©">
            <div class="txt name">${ownerName}</div>
            <div class="txt plot">${plotNumber}</div>
            <div class="txt date">${dateStr}</div>
          </div>
          <script>
            (function() {
              const img = document.getElementById('bg-acte');
              function doPrint() {
                window.focus();
                window.print();
              }
              if (img.complete) {
                doPrint();
              } else {
                img.onload = doPrint;
              }
            })();
          <\/script>
        </body>
        </html>
      `);

      w.document.close();
    });

    backupSaveBtn.addEventListener("click", () => {
      try {
        const dataStr = JSON.stringify(owners, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");

        const now = new Date();
        const pad = n => String(n).padStart(2, "0");
        const fileName =
          "quartier_etoiles_horde_backup_" +
          now.getFullYear() + "-" +
          pad(now.getMonth() + 1) + "-" +
          pad(now.getDate()) + "_" +
          pad(now.getHours()) + "h" +
          pad(now.getMinutes()) +
          ".json";

        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert("Sauvegarde tÃ©lÃ©chargÃ©e sur votre ordinateur.");
      } catch (e) {
        alert("Erreur lors de la crÃ©ation de la sauvegarde.");
      }
    });

    backupLoadBtn.addEventListener("click", () => {
      backupFileInput.click();
    });

    backupFileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const imported = JSON.parse(reader.result);
          if (typeof imported !== "object" || imported === null) {
            throw new Error("JSON invalide");
          }
          owners = imported;
          saveJSON(OWNERS_KEY, owners);
          updatePlotColors();
          applyVisibilityFilters();
          updateAvailableCount();
          syncOwnersToServer();
          alert("Sauvegarde chargÃ©e avec succÃ¨s !");
        } catch (e) {
          alert("Fichier invalide : impossible de charger la sauvegarde.");
        } finally {
          backupFileInput.value = "";
        }
      };
      reader.readAsText(file);
    });

    const popup       = document.getElementById("admin-popup");
    const passInput   = document.getElementById("admin-pass");
    const showPass    = document.getElementById("show-pass");
    const validateBtn = document.getElementById("admin-validate");
    const adminBtn    = document.getElementById("open-admin");

    showPass.addEventListener("change", () => {
      passInput.type = showPass.checked ? "text" : "password";
    });

    adminBtn.addEventListener("click", () => {
      popup.style.display = "block";
      passInput.value = "";
      passInput.focus();
    });

    validateBtn.addEventListener("click", async () => {
      try {
        const userHash = await sha256(passInput.value);
        if (userHash === ADMIN_HASH) {
          popup.style.display = "none";
          panel.style.display = "block";
          localStorage.setItem(ADMIN_FLAG, "true");
          adminBtn.textContent = "âœ… Mode Administrateur actif";
        } else {
          alert("Mot de passe incorrect !");
        }
      } catch (err) {
        console.error("Erreur SHA-256 :", err);
        alert("Erreur technique lors de la vÃ©rification du mot de passe.");
      }
    });

    passInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        validateBtn.click();
      }
    });

    document.getElementById("admin-disconnect").addEventListener("click", () => {
      localStorage.removeItem(ADMIN_FLAG);
      panel.style.display = "none";
      adminBtn.textContent = "ðŸ”‘ Mode Administrateur";
      alert("DÃ©connectÃ© du mode administrateur.");
    });

    if (localStorage.getItem(ADMIN_FLAG) === "true") {
      panel.style.display = "block";
      adminBtn.textContent = "âœ… Mode Administrateur actif";
    }

    const mapContainer = document.querySelector(".map-container");
    const mapInner     = document.querySelector(".map-inner");

    let zoomLevel = 1;
    let translateX = 0;
    let translateY = 0;
    const ZOOM_MIN = 0.5;
    const ZOOM_MAX = 3.0;

    function applyTransform() {
      const cw = mapContainer.clientWidth;
      const ch = mapContainer.clientHeight;

      const iw = cw * zoomLevel;
      const ih = ch * zoomLevel;

      if (zoomLevel <= 1) {
        translateX = (cw - iw) / 2;
        translateY = (ch - ih) / 2;
      } else {
        const minX = cw - iw;
        const maxX = 0;
        const minY = ch - ih;
        const maxY = 0;

        if (translateX < minX) translateX = minX;
        if (translateX > maxX) translateX = maxX;
        if (translateY < minY) translateY = minY;
        if (translateY > maxY) translateY = maxY;
      }

      mapInner.style.transform =
        "translate(" + translateX + "px, " + translateY + "px) scale(" + zoomLevel + ")";
    }

    function focusOnPlot(id) {
      const plot = document.getElementById("plot" + id);
      if (!plot) return;

      zoomLevel = ZOOM_MAX;

      const containerRect = mapContainer.getBoundingClientRect();
      const cx = containerRect.width / 2;
      const cy = containerRect.height / 2;

      const offsetX = plot.offsetLeft + plot.offsetWidth / 2;
      const offsetY = plot.offsetTop + plot.offsetHeight / 2;

      translateX = cx - offsetX * zoomLevel;
      translateY = cy - offsetY * zoomLevel;

      applyTransform();

      plot.classList.add("focus-highlight");
      setTimeout(() => {
        plot.classList.remove("focus-highlight");
      }, 1200);
    }

    mapContainer.addEventListener("wheel", (e) => {
      e.preventDefault();

      const rect = mapContainer.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      const prevZoom = zoomLevel;

      if (e.deltaY < 0) zoomLevel *= 1.1;
      else zoomLevel *= 0.9;

      if (zoomLevel < ZOOM_MIN) zoomLevel = ZOOM_MIN;
      if (zoomLevel > ZOOM_MAX) zoomLevel = ZOOM_MAX;

      const offsetX = (mouseX - translateX) / prevZoom;
      const offsetY = (mouseY - translateY) / prevZoom;

      translateX = mouseX - offsetX * zoomLevel;
      translateY = mouseY - offsetY * zoomLevel;

      applyTransform();
    }, { passive: false });

    let panning = false;
    let startX = 0, startY = 0, startTX = 0, startTY = 0;

    mapContainer.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return;
      panning = true;
      startX = e.clientX;
      startY = e.clientY;
      startTX = translateX;
      startTY = translateY;
    });

    window.addEventListener("mousemove", (e) => {
      if (!panning) return;
      translateX = startTX + (e.clientX - startX);
      translateY = startTY + (e.clientY - startY);
      applyTransform();
    });

    window.addEventListener("mouseup", () => {
      panning = false;
    });

    updatePlotColors();
    applyVisibilityFilters();
    updateAvailableCount();
    applyTransform();
    fetchOwnersFromServer();
  </script>

</body>
</html>
